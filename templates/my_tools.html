{% extends "base.html" %}

{% block title %}My Tools - SHERIA CENTRIC{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Page Header -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mb-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-2 flex items-center">
            <i class="fas fa-tools text-orange-600 mr-3"></i>
            My Tools
        </h1>
        <p class="text-gray-600">Upload your digital signature and official stamp for document authentication</p>
    </div>

    <!-- Signature Upload Section -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8 mb-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-2 flex items-center">
            <i class="fas fa-signature text-purple-600 mr-3"></i>
            Digital Signature
        </h2>
        <p class="text-sm text-gray-500 mb-6">Upload your signature for digital document signing</p>
        
        <form id="signatureForm" method="POST" action="{{ url_for('upload_signature_stamp') }}" enctype="multipart/form-data" class="space-y-6">
            <input type="hidden" name="upload_type" value="signature">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Upload Section -->
                <div>
                    <label for="signature" class="block text-sm font-semibold text-gray-700 mb-2">
                        Upload Signature Image
                    </label>
                    <div class="flex items-center space-x-4">
                        <div class="flex-1">
                            <input 
                                type="file" 
                                id="signature" 
                                name="signature" 
                                accept="image/*"
                                class="hidden"
                                onchange="processSignature(this)"
                            >
                            <label 
                                for="signature" 
                                class="cursor-pointer flex items-center justify-center px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all duration-200 text-sm text-gray-600"
                            >
                                <i class="fas fa-upload mr-2"></i>
                                <span id="signature-file-name">Choose signature image</span>
                            </label>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1.5 ml-1">PNG, JPG, JPEG up to 5MB</p>
                    <div id="signature-processing" class="hidden mt-4">
                        <div class="flex items-center space-x-2 text-sm text-purple-600">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Processing signature...</span>
                        </div>
                    </div>
                </div>

                <!-- Preview Section -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Signature Preview
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 bg-gray-50 min-h-[200px] flex items-center justify-center">
                        <div id="signature-preview-container" class="text-center">
                            <i class="fas fa-signature text-gray-400 text-4xl mb-2"></i>
                            <p class="text-sm text-gray-500">Preview will appear here</p>
                        </div>
                        <canvas id="signature-canvas" class="hidden max-w-full max-h-48 object-contain"></canvas>
                    </div>
                    <div id="signature-confirm" class="hidden mt-4">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center space-x-2 text-sm text-green-700 mb-2">
                                <i class="fas fa-check-circle"></i>
                                <span class="font-semibold">Signature Ready</span>
                            </div>
                            <p class="text-xs text-green-600">Your signature will be securely stored and embedded in documents</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end">
                <button 
                    type="submit"
                    id="signatureSubmitBtn"
                    class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    <i class="fas fa-save mr-2"></i>Save Signature
                </button>
            </div>
        </form>
    </div>

    <!-- Stamp Upload Section -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8 mb-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-2 flex items-center">
            <i class="fas fa-stamp text-indigo-600 mr-3"></i>
            Official Stamp
        </h2>
        <p class="text-sm text-gray-500 mb-6">Upload your official stamp for document authentication</p>
        
        <form id="stampForm" method="POST" action="{{ url_for('upload_signature_stamp') }}" enctype="multipart/form-data" class="space-y-6">
            <input type="hidden" name="upload_type" value="stamp">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Upload Section -->
                <div>
                    <label for="stamp" class="block text-sm font-semibold text-gray-700 mb-2">
                        Upload Stamp Image
                    </label>
                    <div class="flex items-center space-x-4">
                        <div class="flex-1">
                            <input 
                                type="file" 
                                id="stamp" 
                                name="stamp" 
                                accept="image/*"
                                class="hidden"
                                onchange="processStamp(this)"
                            >
                            <label 
                                for="stamp" 
                                class="cursor-pointer flex items-center justify-center px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-all duration-200 text-sm text-gray-600"
                            >
                                <i class="fas fa-upload mr-2"></i>
                                <span id="stamp-file-name">Choose stamp image</span>
                            </label>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1.5 ml-1">PNG, JPG, JPEG up to 5MB</p>
                    <div id="stamp-processing" class="hidden mt-4">
                        <div class="flex items-center space-x-2 text-sm text-indigo-600">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Processing stamp...</span>
                        </div>
                    </div>
                </div>

                <!-- Preview Section -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Stamp Preview
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 bg-gray-50 min-h-[200px] flex items-center justify-center">
                        <div id="stamp-preview-container" class="text-center">
                            <i class="fas fa-stamp text-gray-400 text-4xl mb-2"></i>
                            <p class="text-sm text-gray-500">Preview will appear here</p>
                        </div>
                        <canvas id="stamp-canvas" class="hidden max-w-full max-h-48 object-contain"></canvas>
                    </div>
                    <div id="stamp-confirm" class="hidden mt-4">
                        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                            <div class="flex items-center space-x-2 text-sm text-indigo-700 mb-2">
                                <i class="fas fa-check-circle"></i>
                                <span class="font-semibold">Stamp Ready</span>
                            </div>
                            <p class="text-xs text-indigo-600">Your stamp will be securely stored and embedded in documents</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end">
                <button 
                    type="submit"
                    id="stampSubmitBtn"
                    class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    <i class="fas fa-save mr-2"></i>Save Stamp
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Success/Error Messages -->
<div id="messageContainer" class="hidden fixed top-20 right-4 z-50 max-w-md"></div>
{% endblock %}

{% block extra_js %}
<script>
    function processSignature(input) {
        if (!input.files || !input.files[0]) {
            return;
        }

        const file = input.files[0];
        const fileName = document.getElementById('signature-file-name');
        const processingDiv = document.getElementById('signature-processing');
        const previewContainer = document.getElementById('signature-preview-container');
        const canvas = document.getElementById('signature-canvas');
        const confirmDiv = document.getElementById('signature-confirm');
        const submitBtn = document.getElementById('signatureSubmitBtn');

        fileName.textContent = file.name;
        processingDiv.classList.remove('hidden');

        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            input.value = '';
            processingDiv.classList.add('hidden');
            return;
        }

        // Read and process image
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                requestAnimationFrame(() => {
                    const maxWidth = 400;
                    const maxHeight = 200;
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = Math.round(width * ratio);
                        height = Math.round(height * ratio);
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d', { willReadFrequently: false });
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const imageData = ctx.getImageData(0, 0, width, height);
                    const data = imageData.data;
                    const length = data.length;
                    const threshold = 240;
                    let minX = width, minY = height, maxX = 0, maxY = 0;
                    const contentPixels = [];
                    
                    for (let i = 0; i < length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        const luminance = 0.299 * r + 0.587 * g + 0.114 * b;
                        
                        if (luminance < threshold) {
                            const x = (i / 4) % width;
                            const y = Math.floor((i / 4) / width);
                            contentPixels.push({x, y, r, g, b, luminance, index: i});
                            minX = Math.min(minX, x);
                            minY = Math.min(minY, y);
                            maxX = Math.max(maxX, x);
                            maxY = Math.max(maxY, y);
                        }
                    }
                    
                    const padding = 5;
                    minX = Math.max(0, minX - padding);
                    minY = Math.max(0, minY - padding);
                    maxX = Math.min(width - 1, maxX + padding);
                    maxY = Math.min(height - 1, maxY + padding);
                    
                    const newWidth = maxX - minX + 1;
                    const newHeight = maxY - minY + 1;
                    
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    ctx.clearRect(0, 0, newWidth, newHeight);
                    
                    const newImageData = ctx.createImageData(newWidth, newHeight);
                    const newData = newImageData.data;
                    
                    contentPixels.forEach(pixel => {
                        const newX = pixel.x - minX;
                        const newY = pixel.y - minY;
                        
                        if (newX >= 0 && newX < newWidth && newY >= 0 && newY < newHeight) {
                            const newIndex = (newY * newWidth + newX) * 4;
                            const contrast = 1.5;
                            const normalized = (pixel.luminance / 255) * contrast;
                            const enhanced = Math.max(0, Math.min(255, (1 - normalized) * 255));
                            
                            newData[newIndex] = 0;
                            newData[newIndex + 1] = 0;
                            newData[newIndex + 2] = 0;
                            newData[newIndex + 3] = Math.round(enhanced);
                        }
                    });
                    
                    ctx.putImageData(newImageData, 0, 0);

                    previewContainer.classList.add('hidden');
                    canvas.classList.remove('hidden');
                    confirmDiv.classList.remove('hidden');
                    processingDiv.classList.add('hidden');

                    const processedData = canvas.toDataURL('image/png', 1.0);
                    input.dataset.processedData = processedData;
                    submitBtn.disabled = false;
                });
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function processStamp(input) {
        if (!input.files || !input.files[0]) {
            return;
        }

        const file = input.files[0];
        const fileName = document.getElementById('stamp-file-name');
        const processingDiv = document.getElementById('stamp-processing');
        const previewContainer = document.getElementById('stamp-preview-container');
        const canvas = document.getElementById('stamp-canvas');
        const confirmDiv = document.getElementById('stamp-confirm');
        const submitBtn = document.getElementById('stampSubmitBtn');

        fileName.textContent = file.name;
        processingDiv.classList.remove('hidden');

        if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            input.value = '';
            processingDiv.classList.add('hidden');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                requestAnimationFrame(() => {
                    const maxWidth = 400;
                    const maxHeight = 200;
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = Math.round(width * ratio);
                        height = Math.round(height * ratio);
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d', { willReadFrequently: false });
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const imageData = ctx.getImageData(0, 0, width, height);
                    const data = imageData.data;
                    const length = data.length;
                    const threshold = 240;
                    let minX = width, minY = height, maxX = 0, maxY = 0;
                    const contentPixels = [];
                    
                    for (let i = 0; i < length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        const luminance = 0.299 * r + 0.587 * g + 0.114 * b;
                        
                        if (luminance < threshold) {
                            const x = (i / 4) % width;
                            const y = Math.floor((i / 4) / width);
                            contentPixels.push({x, y, r, g, b, luminance, index: i});
                            minX = Math.min(minX, x);
                            minY = Math.min(minY, y);
                            maxX = Math.max(maxX, x);
                            maxY = Math.max(maxY, y);
                        }
                    }
                    
                    const padding = 5;
                    minX = Math.max(0, minX - padding);
                    minY = Math.max(0, minY - padding);
                    maxX = Math.min(width - 1, maxX + padding);
                    maxY = Math.min(height - 1, maxY + padding);
                    
                    const newWidth = maxX - minX + 1;
                    const newHeight = maxY - minY + 1;
                    
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    ctx.clearRect(0, 0, newWidth, newHeight);
                    
                    const newImageData = ctx.createImageData(newWidth, newHeight);
                    const newData = newImageData.data;
                    
                    contentPixels.forEach(pixel => {
                        const newX = pixel.x - minX;
                        const newY = pixel.y - minY;
                        
                        if (newX >= 0 && newX < newWidth && newY >= 0 && newY < newHeight) {
                            const newIndex = (newY * newWidth + newX) * 4;
                            const contrast = 1.5;
                            const normalized = (pixel.luminance / 255) * contrast;
                            const enhanced = Math.max(0, Math.min(255, (1 - normalized) * 255));
                            
                            newData[newIndex] = 0;
                            newData[newIndex + 1] = 0;
                            newData[newIndex + 2] = 0;
                            newData[newIndex + 3] = Math.round(enhanced);
                        }
                    });
                    
                    ctx.putImageData(newImageData, 0, 0);

                    previewContainer.classList.add('hidden');
                    canvas.classList.remove('hidden');
                    confirmDiv.classList.remove('hidden');
                    processingDiv.classList.add('hidden');

                    const processedData = canvas.toDataURL('image/png', 1.0);
                    input.dataset.processedData = processedData;
                    submitBtn.disabled = false;
                });
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    // Handle form submissions
    document.getElementById('signatureForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const signatureInput = document.getElementById('signature');
        if (signatureInput.files && signatureInput.files[0] && signatureInput.dataset.processedData) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'signature_processed';
            hiddenInput.value = signatureInput.dataset.processedData;
            this.appendChild(hiddenInput);
        }
        submitForm(this, 'signature');
    });

    document.getElementById('stampForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const stampInput = document.getElementById('stamp');
        if (stampInput.files && stampInput.files[0] && stampInput.dataset.processedData) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'stamp_processed';
            hiddenInput.value = stampInput.dataset.processedData;
            this.appendChild(hiddenInput);
        }
        submitForm(this, 'stamp');
    });

    function submitForm(form, type) {
        const formData = new FormData(form);
        const submitBtn = document.getElementById(type + 'SubmitBtn');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
        
        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message || (type === 'signature' ? 'Signature saved successfully!' : 'Stamp saved successfully!'), 'success');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showMessage(data.error || 'An error occurred. Please try again.', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('An error occurred. Please try again.', 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    }

    function showMessage(message, type) {
        const container = document.getElementById('messageContainer');
        const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        
        container.className = `fixed top-20 right-4 z-50 max-w-md ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg`;
        container.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${icon} mr-3 text-xl"></i>
                <span>${message}</span>
            </div>
        `;
        container.classList.remove('hidden');
        
        setTimeout(() => {
            container.classList.add('hidden');
        }, 5000);
    }
</script>
{% endblock %}





