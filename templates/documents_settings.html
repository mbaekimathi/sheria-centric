{% extends "base.html" %}

{% block title %}Documents Settings - SHERIA CENTRIC{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Page Header -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl shadow-xl border border-indigo-200 p-6 mb-6 text-white">
        <div class="flex flex-col md:flex-row items-center justify-between">
            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                <a href="{{ url_for('document_management') }}" class="text-white hover:text-indigo-200 transition-colors">
                    <i class="fas fa-arrow-left text-xl"></i>
                </a>
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold mb-2 flex items-center">
                        <i class="fas fa-cog mr-3"></i>
                        Documents Settings
                    </h1>
                    <p class="text-indigo-100">Configure Google Drive document upload settings</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Drive Upload Settings -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
            <i class="fab fa-google-drive text-indigo-600 mr-3"></i>
            Google Drive Upload Settings
        </h2>
        
        <form id="googleDriveSettingsForm" class="space-y-6">
            <!-- Google Drive Account Information -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-blue-600 mr-3 mt-1"></i>
                    <div>
                        <p class="text-sm font-semibold text-blue-900 mb-2">Automatic Folder Creation</p>
                        <p class="text-xs text-blue-800">
                            The system will automatically create a <strong>"SHERIA CENTRIC"</strong> folder in your Google Drive. 
                            Within this folder, subfolders will be automatically created for each user (client or employee) 
                            with the appropriate document type folders. No manual folder setup is required.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Google Drive Authentication -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Google Drive Account <span class="text-red-500">*</span>
                </label>
                <p class="text-xs text-gray-500 mb-3">
                    Connect your Google Drive account to enable automatic folder creation and document uploads. 
                    You will be able to select which Google account to connect.
                </p>
                
                <!-- Not Connected State -->
                <div id="notConnectedState">
                    <button 
                        type="button"
                        onclick="connectGoogleDrive()"
                        class="px-6 py-3 bg-white border-2 border-gray-300 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-colors duration-200 font-semibold text-gray-700 flex items-center"
                    >
                        <i class="fab fa-google mr-2 text-red-500"></i>
                        Connect Google Drive Account
                    </button>
                    <p class="text-xs text-gray-500 mt-2">
                        <i class="fas fa-shield-alt mr-1"></i>
                        Clicking this button will open Google's account picker where you can select which account to connect.
                    </p>
                </div>

                <!-- Connected State -->
                <div id="connectedState" class="hidden">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                                    <i class="fas fa-check-circle text-green-600"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-900">Connected to Google Drive</p>
                                    <p class="text-xs text-gray-600" id="connectedAccountEmail">No account selected</p>
                                </div>
                            </div>
                            <button 
                                type="button"
                                onclick="disconnectGoogleDrive()"
                                class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors duration-200 font-semibold text-sm"
                            >
                                <i class="fas fa-unlink mr-2"></i>Disconnect
                            </button>
                        </div>
                        <div class="mt-3 pt-3 border-t border-green-200">
                            <button 
                                type="button"
                                onclick="switchGoogleAccount()"
                                class="text-sm text-indigo-600 hover:text-indigo-700 font-semibold"
                            >
                                <i class="fas fa-exchange-alt mr-1"></i>Switch Account
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Folder Structure Information -->
            <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-6">
                <h3 class="text-lg font-semibold text-indigo-900 mb-4 flex items-center">
                    <i class="fas fa-folder-tree mr-2"></i>
                    Automatic Folder Structure
                </h3>
                <p class="text-sm text-indigo-800 mb-4">
                    The system will automatically create the following folder structure in Google Drive:
                </p>
                
                <div class="bg-white rounded-lg p-4 mb-4 border border-indigo-100">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-folder text-yellow-500 mr-2"></i>
                        <span class="font-bold text-gray-900">SHERIA CENTRIC</span>
                        <span class="ml-2 text-xs text-gray-500">(Auto-created)</span>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <!-- Client Structure -->
                    <div class="bg-white rounded-lg p-4 border border-indigo-100">
                        <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                            <i class="fas fa-user text-indigo-600 mr-2"></i>
                            Client Documents Structure
                        </h4>
                        <div class="ml-6 space-y-2 text-sm text-gray-700">
                            <div class="flex items-start">
                                <i class="fas fa-folder text-yellow-500 mr-2 mt-1"></i>
                                <div>
                                    <span class="font-semibold">[Client Name]</span>
                                    <div class="ml-4 mt-1 space-y-1">
                                        <div class="flex items-center">
                                            <i class="fas fa-folder text-blue-500 mr-2"></i>
                                            <span>CLIENT_PERSONAL_DOCUMENT</span>
                                        </div>
                                        <div class="flex items-center">
                                            <i class="fas fa-folder text-blue-500 mr-2"></i>
                                            <span>CLIENT_CASE_DOCUMENT</span>
                                        </div>
                                        <div class="flex items-center">
                                            <i class="fas fa-folder text-blue-500 mr-2"></i>
                                            <span>CLIENT_OTHER_MATTERS</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Employee Structure -->
                    <div class="bg-white rounded-lg p-4 border border-indigo-100">
                        <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                            <i class="fas fa-user-tie text-indigo-600 mr-2"></i>
                            Employee Documents Structure
                        </h4>
                        <div class="ml-6 space-y-2 text-sm text-gray-700">
                            <div class="flex items-start">
                                <i class="fas fa-folder text-yellow-500 mr-2 mt-1"></i>
                                <div>
                                    <span class="font-semibold">[Employee Name]</span>
                                    <div class="ml-4 mt-1 space-y-1">
                                        <div class="flex items-center">
                                            <i class="fas fa-folder text-blue-500 mr-2"></i>
                                            <span>EMPLOYEE_PERSONAL_DOCUMENT</span>
                                        </div>
                                        <div class="flex items-center">
                                            <i class="fas fa-folder text-blue-500 mr-2"></i>
                                            <span>EMPLOYEE_WORK_DOCUMENTS</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                    <p class="text-xs text-green-800">
                        <i class="fas fa-check-circle mr-1"></i>
                        <strong>Automatic Creation:</strong> The "SHERIA CENTRIC" folder and all user subfolders will be created automatically 
                        when you connect your Google Drive account. Subfolders for each user (CLIENT_PERSONAL_DOCUMENT, CLIENT_CASE_DOCUMENT, 
                        CLIENT_OTHER_MATTERS, EMPLOYEE_PERSONAL_DOCUMENT, EMPLOYEE_WORK_DOCUMENTS) will be created automatically when documents are uploaded for that user.
                    </p>
                </div>
            </div>

            <!-- Create Folder Button -->
            <div class="flex items-center justify-between py-4 border-t border-gray-200">
                <div>
                    <p class="text-sm font-semibold text-gray-900">Create SHERIA CENTRIC Folder</p>
                    <p class="text-xs text-gray-500">Manually trigger the creation of the main folder structure</p>
                </div>
                <button 
                    type="button"
                    onclick="createMainFolder()"
                    class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors duration-200 font-semibold text-sm"
                >
                    <i class="fas fa-folder-plus mr-2"></i>Create Folder
                </button>
            </div>

            <!-- Save Button -->
            <div class="flex justify-end space-x-4 pt-4 border-t border-gray-200">
                <a 
                    href="{{ url_for('document_management') }}"
                    class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors duration-200 font-semibold"
                >
                    <i class="fas fa-times mr-2"></i>Cancel
                </a>
                <button 
                    type="submit"
                    class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white rounded-lg hover:from-indigo-700 hover:to-indigo-800 transition-all duration-200 font-semibold shadow-md hover:shadow-lg"
                >
                    <i class="fas fa-save mr-2"></i>Save Settings
                </button>
            </div>
        </form>
    </div>

    <!-- Current Settings Display (if saved) -->
    <div id="currentSettings" class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 hidden">
        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-info-circle text-indigo-600 mr-3"></i>
            Current Settings
        </h2>
        <div class="space-y-2">
            <div class="flex items-center justify-between py-2 border-b border-gray-200">
                <span class="text-sm font-semibold text-gray-700">Google Drive Status:</span>
                <span class="text-sm text-green-600 font-semibold flex items-center">
                    <i class="fas fa-check-circle mr-1"></i>Connected
                </span>
            </div>
            <div class="flex items-center justify-between py-2 border-b border-gray-200">
                <span class="text-sm font-semibold text-gray-700">SHERIA CENTRIC Folder:</span>
                <a href="#" id="currentFolderLink" target="_blank" class="text-sm text-indigo-600 hover:text-indigo-700">
                    <i class="fas fa-external-link-alt mr-1"></i>View Folder
                </a>
            </div>
            <div class="flex items-center justify-between py-2">
                <span class="text-sm font-semibold text-gray-700">Last Updated:</span>
                <span class="text-sm text-gray-600" id="lastUpdated">-</span>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageContainer" class="hidden fixed top-20 right-4 z-50 max-w-md"></div>
</div>

<script>
// Connect Google Drive function - Opens Google OAuth with account picker
function connectGoogleDrive() {
    showMessage('Opening Google account picker...', 'info');
    
    // Fetch authorization URL from server
    fetch('/api/auth/google-drive/authorize')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showMessage(data.error, 'error');
                return;
            }
            
            if (!data.auth_url) {
                showMessage('Failed to get authorization URL', 'error');
                return;
            }
            
            // Open Google OAuth popup with account selection
            const width = 500;
            const height = 600;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            
            const popup = window.open(
                data.auth_url,
                'Google Drive Authentication',
                `width=${width},height=${height},left=${left},top=${top},toolbar=no,location=no,status=no,menubar=no`
            );
            
            // Listen for OAuth callback message from popup
            const messageHandler = function(event) {
                if (event.data.type === 'GOOGLE_DRIVE_CONNECTED') {
                    handleGoogleDriveConnected(event.data.account);
                    window.removeEventListener('message', messageHandler);
                    if (popup && !popup.closed) {
                        popup.close();
                    }
                } else if (event.data.type === 'GOOGLE_DRIVE_ERROR') {
                    showMessage(event.data.error || 'Authentication failed', 'error');
                    window.removeEventListener('message', messageHandler);
                    if (popup && !popup.closed) {
                        popup.close();
                    }
                }
            };
            
            window.addEventListener('message', messageHandler);
            
            // Check if popup was closed manually
            const checkClosed = setInterval(() => {
                if (popup.closed) {
                    clearInterval(checkClosed);
                    window.removeEventListener('message', messageHandler);
                    // Optionally check status
                    checkConnectionStatus();
                }
            }, 1000);
        })
        .catch(error => {
            console.error('Error connecting to Google Drive:', error);
            showMessage('Error connecting to Google Drive. Please try again.', 'error');
        });
}

// Handle successful Google Drive connection
function handleGoogleDriveConnected(accountData) {
    document.getElementById('notConnectedState').classList.add('hidden');
    document.getElementById('connectedState').classList.remove('hidden');
    document.getElementById('connectedAccountEmail').textContent = accountData.email || accountData.name || 'Connected';
    showMessage('Google Drive connected successfully!', 'success');
}

// Check connection status
function checkConnectionStatus() {
    fetch('/api/auth/google-drive/status')
        .then(response => response.json())
        .then(data => {
            if (data.connected) {
                handleGoogleDriveConnected(data.account);
            }
        })
        .catch(error => {
            console.error('Error checking connection status:', error);
        });
}

// Disconnect Google Drive
function disconnectGoogleDrive() {
    if (!confirm('Are you sure you want to disconnect Google Drive? This will prevent automatic document uploads.')) {
        return;
    }
    
    showMessage('Disconnecting Google Drive...', 'info');
    
    fetch('/api/auth/google-drive/disconnect', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('notConnectedState').classList.remove('hidden');
            document.getElementById('connectedState').classList.add('hidden');
            document.getElementById('currentSettings').classList.add('hidden');
            showMessage('Google Drive disconnected successfully', 'success');
        } else {
            showMessage(data.error || 'Error disconnecting', 'error');
        }
    })
    .catch(error => {
        showMessage('Error disconnecting. Please try again.', 'error');
    });
}

// Switch Google Account
function switchGoogleAccount() {
    disconnectGoogleDrive();
    setTimeout(() => {
        connectGoogleDrive();
    }, 500);
}

// Create main folder function
function createMainFolder() {
    const connectedState = document.getElementById('connectedState');
    if (connectedState.classList.contains('hidden')) {
        showMessage('Please connect Google Drive first', 'error');
        return;
    }
    
    showMessage('Creating SHERIA CENTRIC folder...', 'info');
    
    fetch('/api/documents/create-main-folder', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message || 'SHERIA CENTRIC folder created successfully!', 'success');
            document.getElementById('currentSettings').classList.remove('hidden');
            document.getElementById('currentFolderLink').href = data.folder_url;
            document.getElementById('currentFolderLink').textContent = 'View Folder';
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
        } else {
            showMessage(data.error || 'Error creating folder', 'error');
        }
    })
    .catch(error => {
        console.error('Error creating folder:', error);
        showMessage('Error creating folder. Please try again.', 'error');
    });
}

// Check connection status on page load
document.addEventListener('DOMContentLoaded', function() {
    checkConnectionStatus();
});

// Form submission (for saving settings)
document.getElementById('googleDriveSettingsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const connectedState = document.getElementById('connectedState');
    if (connectedState.classList.contains('hidden')) {
        showMessage('Please connect Google Drive first', 'error');
        return;
    }
    
    // Show loading
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
    
    // In a real implementation, save settings to server
    setTimeout(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        showMessage('Settings saved successfully!', 'success');
    }, 1000);
    
    // Real implementation would be:
    // fetch('/api/documents/google-drive-settings', {
    //     method: 'POST',
    //     headers: {'Content-Type': 'application/json'},
    //     body: JSON.stringify({ connected: true })
    // })
    // .then(response => response.json())
    // .then(data => {
    //     submitBtn.disabled = false;
    //     submitBtn.innerHTML = originalText;
    //     if (data.success) {
    //         showMessage('Settings saved successfully!', 'success');
    //     } else {
    //         showMessage(data.error || 'Error saving settings', 'error');
    //     }
    // });
});

// Message display function
function showMessage(message, type) {
    const container = document.getElementById('messageContainer');
    const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
    
    container.className = `fixed top-20 right-4 z-50 max-w-md ${bgColor} text-white p-4 rounded-lg shadow-lg`;
    container.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${icon} mr-3 text-xl"></i>
            <span>${message}</span>
        </div>
    `;
    container.classList.remove('hidden');
    
    setTimeout(() => {
        container.classList.add('hidden');
    }, 5000);
}
</script>
{% endblock %}
