{% extends "base.html" %}

{% block title %}Edit Matter - SHERIA CENTRIC{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mb-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-2 flex items-center">
            <i class="fas fa-edit text-indigo-600 mr-3"></i>
            Edit Matter
        </h1>
        <p class="text-gray-600">Update matter information for Reference Number: <span class="font-semibold">{{ matter_data.matter_reference_number }}</span></p>
    </div>

    <!-- Matter Edit Form -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8 mb-6">
        <form id="matterEditForm" class="space-y-6">
            <input type="hidden" id="matter_id" name="matter_id" value="{{ matter_id }}" />
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Matter Title -->
                <div class="md:col-span-2">
                    <label for="matter_title" class="block text-sm font-semibold text-gray-700 mb-2">
                        Matter Title <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="matter_title" 
                        name="matter_title"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent uppercase"
                        placeholder="Enter matter title..."
                        value="{{ matter_data.matter_title or '' }}"
                        autocomplete="off"
                        required
                        oninput="this.value = this.value.toUpperCase()"
                    />
                </div>

                <!-- Matter Category -->
                <div class="md:col-span-2">
                    <label for="matter_category" class="block text-sm font-semibold text-gray-700 mb-2">
                        Matter Category <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="matter_category" 
                            name="matter_category"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent uppercase"
                            placeholder="Enter or select matter category..."
                            value="{{ matter_data.matter_category or '' }}"
                            autocomplete="off"
                            required
                            oninput="this.value = this.value.toUpperCase(); searchCategories(this.value)"
                        />
                        <div id="matter_category_dropdown" class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                        </div>
                    </div>
                </div>

                <!-- Client Instructions -->
                <div class="md:col-span-2">
                    <label for="client_instructions" class="block text-sm font-semibold text-gray-700 mb-2">
                        Client Instructions <span class="text-gray-500 text-xs">(Optional)</span>
                    </label>
                    <textarea 
                        id="client_instructions" 
                        name="client_instructions"
                        rows="4"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        placeholder="Enter client instructions or requirements..."
                    >{{ matter_data.client_instructions or '' }}</textarea>
                </div>

                <!-- Assigned Employee -->
                <div class="md:col-span-2">
                    <label for="employee_search" class="block text-sm font-semibold text-gray-700 mb-2">
                        Assigned Employee <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="employee_search" 
                            name="employee_search"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            placeholder="Search employee by name..."
                            value="{{ matter_data.assigned_employee_name or '' }}"
                            autocomplete="off"
                            required
                            oninput="searchEmployees(this.value)"
                        />
                        <input type="hidden" id="assigned_employee_id" name="assigned_employee_id" value="{{ matter_data.assigned_employee_id or '' }}" />
                        <div id="employee_dropdown" class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                        </div>
                        <i class="fas fa-search absolute right-3 top-4 text-gray-400"></i>
                    </div>
                </div>

                <!-- Date Opened -->
                <div>
                    <label for="date_opened" class="block text-sm font-semibold text-gray-700 mb-2">
                        Date Opened <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="date" 
                        id="date_opened" 
                        name="date_opened"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        value="{{ matter_data.date_opened or '' }}"
                        required
                    />
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                <a href="{{ url_for('matter_details', matter_id=matter_id) }}" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    <i class="fas fa-times mr-2"></i>Cancel
                </a>
                <button 
                    type="submit"
                    id="submitBtn"
                    class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <i class="fas fa-save mr-2"></i>Update Matter
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function searchEmployees(query) {
    const dropdown = document.getElementById('employee_dropdown');
    
    if (query.length < 2) {
        dropdown.classList.add('hidden');
        return;
    }
    
    fetch(`/api/matters/employees/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            dropdown.innerHTML = '';
            
            if (data.error || !data.employees || data.employees.length === 0) {
                dropdown.innerHTML = '<div class="px-4 py-2 text-gray-500">No employees found</div>';
                dropdown.classList.remove('hidden');
                return;
            }
            
            data.employees.forEach(employee => {
                const item = document.createElement('div');
                item.className = 'px-4 py-2 hover:bg-indigo-50 cursor-pointer border-b border-gray-100';
                const name = employee.full_name || '';
                const code = employee.employee_code || '';
                item.textContent = `${name}${code ? ' (' + code + ')' : ''}`;
                item.onclick = () => {
                    document.getElementById('employee_search').value = `${name}${code ? ' (' + code + ')' : ''}`;
                    document.getElementById('assigned_employee_id').value = employee.id;
                    dropdown.classList.add('hidden');
                };
                dropdown.appendChild(item);
            });
            
            dropdown.classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error:', error);
            dropdown.innerHTML = '<div class="px-4 py-2 text-red-500">Error searching employees</div>';
            dropdown.classList.remove('hidden');
        });
}

function searchCategories(query) {
    const dropdown = document.getElementById('matter_category_dropdown');
    
    if (query.length < 1) {
        dropdown.classList.add('hidden');
        return;
    }
    
    fetch(`/api/matters/categories/search?q=${encodeURIComponent(query.toUpperCase())}`)
        .then(response => response.json())
        .then(data => {
            dropdown.innerHTML = '';
            
            if (data.error || !data.categories || data.categories.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }
            
            data.categories.forEach(category => {
                const item = document.createElement('div');
                item.className = 'px-4 py-2 hover:bg-indigo-50 cursor-pointer border-b border-gray-100';
                item.textContent = category.category_name;
                item.onclick = () => {
                    document.getElementById('matter_category').value = category.category_name;
                    dropdown.classList.add('hidden');
                };
                dropdown.appendChild(item);
            });
            
            dropdown.classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error:', error);
            dropdown.classList.add('hidden');
        });
}

document.getElementById('matterEditForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    
    // Validate required fields
    if (!document.getElementById('assigned_employee_id').value) {
        alert('Please select an assigned employee');
        return;
    }
    
    const formData = {
        matter_title: document.getElementById('matter_title').value.trim().toUpperCase(),
        matter_category: document.getElementById('matter_category').value.trim().toUpperCase(),
        assigned_employee_id: parseInt(document.getElementById('assigned_employee_id').value),
        date_opened: document.getElementById('date_opened').value,
        client_instructions: document.getElementById('client_instructions').value.trim()
    };
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';
    
    fetch(`/api/matters/update/${document.getElementById('matter_id').value}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        
        if (data.success) {
            alert('Matter updated successfully!');
            window.location.href = '{{ url_for("matter_details", matter_id=matter_id) }}';
        } else {
            alert(data.error || 'Error updating matter');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        alert('An error occurred while updating the matter.');
    });
});

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    const employeeDropdown = document.getElementById('employee_dropdown');
    const employeeSearch = document.getElementById('employee_search');
    const categoryDropdown = document.getElementById('matter_category_dropdown');
    const categorySearch = document.getElementById('matter_category');
    
    if (employeeDropdown && employeeSearch && !employeeDropdown.contains(event.target) && event.target !== employeeSearch) {
        employeeDropdown.classList.add('hidden');
    }
    
    if (categoryDropdown && categorySearch && !categoryDropdown.contains(event.target) && event.target !== categorySearch) {
        categoryDropdown.classList.add('hidden');
    }
});
</script>
{% endblock %}
