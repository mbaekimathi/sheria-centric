{% extends "base.html" %}

{% block title %}Case Calendar - SHERIA CENTRIC{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Page Header -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl shadow-xl border border-indigo-200 p-6 mb-6 text-white">
        <div class="flex flex-col md:flex-row items-center justify-between">
            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                <a href="{{ url_for('case_details', case_id=case_id) }}" class="text-white hover:text-indigo-200 transition-colors">
                    <i class="fas fa-arrow-left text-xl"></i>
                </a>
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold mb-2 flex items-center">
                        <i class="fas fa-calendar-alt mr-3"></i>
                        Case Calendar
                    </h1>
                    <p class="text-indigo-100">Tracking Number: <span class="font-semibold text-white">{{ case_data.tracking_number }}</span></p>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Calendar -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Modern Calendar View -->
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-4 sm:p-6 overflow-hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-calendar-week text-indigo-600 mr-3"></i>
                        Calendar Overview
                    </h2>
                    <div class="flex items-center space-x-2">
                        <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                            <i class="fas fa-chevron-left text-gray-600"></i>
                        </button>
                        <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                            <i class="fas fa-chevron-right text-gray-600"></i>
                        </button>
                    </div>
                </div>
                
                <div id="calendar-container" class="w-full">
                    <!-- Calendar will be generated by JavaScript -->
                </div>
            </div>

            <!-- Upcoming Court Dates -->
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-4 sm:p-6">
                <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <i class="fas fa-calendar-check text-green-600 mr-3"></i>
                    Upcoming Court Dates
                </h2>
                
                {% if upcoming_proceedings and upcoming_proceedings|length > 0 %}
                <div class="space-y-4">
                    {% for proceeding in upcoming_proceedings %}
                    <div class="bg-gradient-to-r from-green-50 via-emerald-50 to-teal-50 rounded-xl p-4 sm:p-6 border border-green-200 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4">
                            <div class="flex items-center space-x-3 mb-3 sm:mb-0">
                                <div class="bg-gradient-to-br from-green-600 to-emerald-600 text-white rounded-xl px-4 py-3 font-bold text-lg sm:text-xl shadow-lg">
                                    {{ proceeding.next_court_date.split('-')[2] if proceeding.next_court_date else 'N/A' }}
                                </div>
                                <div>
                                    <p class="text-xs text-gray-600 font-medium">
                                        {{ proceeding.next_court_date.split('-')[1] if proceeding.next_court_date else 'N/A' }}/{{ proceeding.next_court_date.split('-')[0] if proceeding.next_court_date else 'N/A' }}
                                    </p>
                                    <p class="text-sm font-semibold text-gray-800" id="upcoming-day-{{ loop.index }}"></p>
                                </div>
                            </div>
                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">Upcoming</span>
                        </div>
                        <h3 class="text-lg sm:text-xl font-bold text-gray-900 mb-2">{{ proceeding.court_activity_type or 'N/A' }}</h3>
                        <p class="text-sm text-gray-600 mb-4">From proceeding dated: <span class="font-semibold">{{ proceeding.date_of_court_appeared or 'N/A' }}</span></p>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                            {% if proceeding.court_room %}
                            <div class="bg-white rounded-lg p-3 border border-gray-200">
                                <p class="text-xs text-gray-500 font-medium mb-1">Court Room</p>
                                <p class="text-sm font-semibold text-gray-900">{{ proceeding.court_room }}</p>
                            </div>
                            {% endif %}
                            {% if proceeding.judicial_officer %}
                            <div class="bg-white rounded-lg p-3 border border-gray-200">
                                <p class="text-xs text-gray-500 font-medium mb-1">Judicial Officer</p>
                                <p class="text-sm font-semibold text-gray-900">{{ proceeding.judicial_officer }}</p>
                            </div>
                            {% endif %}
                            {% if proceeding.attendance %}
                            <div class="bg-white rounded-lg p-3 border border-gray-200">
                                <p class="text-xs text-gray-500 font-medium mb-1">Previous Attendance</p>
                                <p class="text-sm font-semibold text-gray-900">{{ proceeding.attendance }}</p>
                            </div>
                            {% endif %}
                            {% if proceeding.next_attendance %}
                            <div class="bg-white rounded-lg p-3 border border-gray-200">
                                <p class="text-xs text-gray-500 font-medium mb-1">Next Client Attendance</p>
                                <p class="text-sm font-semibold text-gray-900">{{ proceeding.next_attendance }}</p>
                                {% if proceeding.virtual_link %}
                                <p class="text-xs text-blue-600 mt-1">
                                    <i class="fas fa-video mr-1"></i>
                                    <a href="{{ proceeding.virtual_link }}" target="_blank" class="hover:underline break-all">{{ proceeding.virtual_link[:50] }}{% if proceeding.virtual_link|length > 50 %}...{% endif %}</a>
                                </p>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        
                        {% if proceeding.outcome_orders %}
                        <div class="mt-4 pt-4 border-t border-green-200">
                            <p class="text-xs text-gray-500 font-medium mb-1">Current Case Outcome</p>
                            <p class="text-sm text-gray-900 font-semibold">{{ proceeding.outcome_orders }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-12">
                    <i class="fas fa-calendar-times text-gray-300 text-5xl sm:text-6xl mb-4"></i>
                    <p class="text-gray-600 text-lg font-semibold">No upcoming court dates scheduled</p>
                    <p class="text-gray-500 mt-2 text-sm">Next court dates will appear here once proceedings are added with future dates.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Right Column: Court Appearance History -->
        <div class="space-y-6">
            <!-- Court Appearance History -->
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-4 sm:p-6">
                <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <i class="fas fa-history text-blue-600 mr-3"></i>
                    Court Appearance History
                </h2>
                
                {% if all_proceedings and all_proceedings|length > 0 %}
                <div class="space-y-3 max-h-[800px] overflow-y-auto pr-2 custom-scrollbar">
                    {% for proceeding in all_proceedings %}
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-200 hover:shadow-md transition-all duration-200">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center space-x-2">
                                <div class="bg-blue-600 text-white rounded-lg px-3 py-1.5 font-bold text-sm">
                                    {{ proceeding.date_of_court_appeared.split('-')[2] if proceeding.date_of_court_appeared else 'N/A' }}
                                </div>
                                <div>
                                    <p class="text-xs text-gray-600 font-medium">
                                        {{ proceeding.date_of_court_appeared.split('-')[1] if proceeding.date_of_court_appeared else 'N/A' }}/{{ proceeding.date_of_court_appeared.split('-')[0] if proceeding.date_of_court_appeared else 'N/A' }}
                                    </p>
                                    <p class="text-xs font-semibold text-gray-700" id="history-day-{{ loop.index }}"></p>
                                </div>
                            </div>
                        </div>
                        <h4 class="text-sm font-bold text-gray-900 mb-1">{{ proceeding.court_activity_type or 'N/A' }}</h4>
                        {% if proceeding.court_room %}
                        <p class="text-xs text-gray-600 mb-1"><i class="fas fa-door-open mr-1"></i>{{ proceeding.court_room }}</p>
                        {% endif %}
                        {% if proceeding.judicial_officer %}
                        <p class="text-xs text-gray-600 mb-1"><i class="fas fa-gavel mr-1"></i>{{ proceeding.judicial_officer }}</p>
                        {% endif %}
                        {% if proceeding.outcome_orders %}
                        <p class="text-xs text-gray-700 mt-2 font-semibold">{{ proceeding.outcome_orders }}</p>
                        {% endif %}
                        {% if proceeding.next_court_date %}
                        <div class="mt-2 pt-2 border-t border-blue-200">
                            <p class="text-xs text-green-700 font-semibold">
                                <i class="fas fa-arrow-right mr-1"></i>Next: {{ proceeding.next_court_date }}
                            </p>
                        </div>
                        {% endif %}
                        {% if proceeding.next_attendance %}
                        <div class="mt-2 pt-2 border-t border-blue-200">
                            <p class="text-xs text-purple-700 font-semibold">
                                <i class="fas fa-user-check mr-1"></i>Next Attendance: {{ proceeding.next_attendance }}
                            </p>
                            {% if proceeding.virtual_link %}
                            <p class="text-xs text-blue-600 mt-1">
                                <i class="fas fa-video mr-1"></i>
                                <a href="{{ proceeding.virtual_link }}" target="_blank" class="hover:underline break-all">{{ proceeding.virtual_link[:40] }}{% if proceeding.virtual_link|length > 40 %}...{% endif %}</a>
                            </p>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <i class="fas fa-inbox text-gray-300 text-4xl mb-3"></i>
                    <p class="text-gray-500 text-sm">No court appearances recorded yet</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.custom-scrollbar::-webkit-scrollbar {
    width: 6px;
}
.custom-scrollbar::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
}
.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #555;
}
</style>

<script>
// Get current month and year
const now = new Date();
let currentMonth = now.getMonth();
let currentYear = now.getFullYear();

// Calendar events from server
const calendarEvents = {{ calendar_events|tojson }};
const appearanceEvents = {{ appearance_events|tojson }};

// Month names
const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                   'July', 'August', 'September', 'October', 'November', 'December'];

const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
const dayNamesShort = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

// Set day names for proceedings
document.addEventListener('DOMContentLoaded', function() {
    {% for proceeding in upcoming_proceedings %}
    {% if proceeding.next_court_date %}
    const upcomingDate{{ loop.index }} = new Date('{{ proceeding.next_court_date }}');
    const upcomingDayName{{ loop.index }} = dayNames[upcomingDate{{ loop.index }}.getDay()];
    const upcomingEl{{ loop.index }} = document.getElementById('upcoming-day-{{ loop.index }}');
    if (upcomingEl{{ loop.index }}) {
        upcomingEl{{ loop.index }}.textContent = upcomingDayName{{ loop.index }};
    }
    {% endif %}
    {% endfor %}
    
    {% for proceeding in all_proceedings %}
    {% if proceeding.date_of_court_appeared %}
    const historyDate{{ loop.index }} = new Date('{{ proceeding.date_of_court_appeared }}');
    const historyDayName{{ loop.index }} = dayNamesShort[historyDate{{ loop.index }}.getDay()];
    const historyEl{{ loop.index }} = document.getElementById('history-day-{{ loop.index }}');
    if (historyEl{{ loop.index }}) {
        historyEl{{ loop.index }}.textContent = historyDayName{{ loop.index }};
    }
    {% endif %}
    {% endfor %}
    
    // Generate calendar
    generateCalendar();
});

function generateCalendar() {
    const container = document.getElementById('calendar-container');
    if (!container) return;
    
    // Clear container
    container.innerHTML = '';
    
    // Month/Year Header with Navigation
    const headerDiv = document.createElement('div');
    headerDiv.className = 'flex items-center justify-between mb-6 pb-4 border-b border-gray-200';
    
    const monthYear = document.createElement('div');
    monthYear.className = 'text-2xl md:text-3xl font-bold text-gray-900';
    monthYear.textContent = `${monthNames[currentMonth]} ${currentYear}`;
    headerDiv.appendChild(monthYear);
    
    container.appendChild(headerDiv);
    
    // Calendar Grid Container
    const gridContainer = document.createElement('div');
    gridContainer.className = 'grid grid-cols-7 gap-1 sm:gap-2';
    
    // Day Headers
    dayNamesShort.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'text-center font-bold text-gray-700 py-2 text-xs sm:text-sm';
        dayHeader.textContent = day;
        gridContainer.appendChild(dayHeader);
    });
    
    // Get first day of month and number of days
    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const today = new Date();
    const isCurrentMonth = currentYear === today.getFullYear() && currentMonth === today.getMonth();
    
    // Add empty cells for days before month starts
    for (let i = 0; i < firstDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'aspect-square';
        gridContainer.appendChild(emptyCell);
    }
    
    // Add cells for each day of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        cell.className = 'aspect-square border border-gray-200 rounded-lg p-1 sm:p-2 relative transition-all duration-200 hover:shadow-md';
        
        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = isCurrentMonth && day === today.getDate();
        
        // Check if this date has events
        if (calendarEvents[dateStr]) {
            const events = calendarEvents[dateStr];
            const hasNext = events.some(e => e.type === 'next');
            const hasAppeared = events.some(e => e.type === 'appeared');
            
            if (hasNext) {
                cell.className += ' bg-gradient-to-br from-green-100 to-emerald-100 border-green-300';
            } else if (hasAppeared) {
                cell.className += ' bg-gradient-to-br from-blue-100 to-indigo-100 border-blue-300';
            }
            
            const dayNumber = document.createElement('div');
            dayNumber.className = `text-xs sm:text-sm font-bold mb-1 ${isToday ? 'text-white bg-indigo-600 rounded-full w-6 h-6 flex items-center justify-center' : 'text-gray-900'}`;
            dayNumber.textContent = day;
            cell.appendChild(dayNumber);
            
            // Event indicators
            const eventIndicators = document.createElement('div');
            eventIndicators.className = 'flex flex-wrap gap-0.5 justify-center';
            
            if (hasNext) {
                const nextIndicator = document.createElement('div');
                nextIndicator.className = 'w-1.5 h-1.5 sm:w-2 sm:h-2 bg-green-600 rounded-full';
                nextIndicator.title = 'Upcoming court date';
                eventIndicators.appendChild(nextIndicator);
            }
            if (hasAppeared) {
                const appearedIndicator = document.createElement('div');
                appearedIndicator.className = 'w-1.5 h-1.5 sm:w-2 sm:h-2 bg-blue-600 rounded-full';
                appearedIndicator.title = 'Court appearance';
                eventIndicators.appendChild(appearedIndicator);
            }
            
            cell.appendChild(eventIndicators);
            
            // Event count tooltip
            const eventCount = events.length;
            cell.title = `${eventCount} event(s) on this day`;
            cell.style.cursor = 'pointer';
        } else {
            const dayNumber = document.createElement('div');
            dayNumber.className = `text-xs sm:text-sm ${isToday ? 'text-white bg-indigo-600 rounded-full w-6 h-6 flex items-center justify-center font-bold' : 'text-gray-600'}`;
            dayNumber.textContent = day;
            cell.appendChild(dayNumber);
        }
        
        // Highlight today
        if (isToday) {
            cell.className += ' ring-2 ring-indigo-500';
        }
        
        gridContainer.appendChild(cell);
    }
    
    container.appendChild(gridContainer);
}

// Navigation buttons
function changeMonth(direction) {
    currentMonth += direction;
    if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
    } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
    }
    generateCalendar();
}
</script>
{% endblock %}
