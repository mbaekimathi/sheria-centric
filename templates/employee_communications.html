{% extends "base.html" %}

{% block title %}Employee Communications - SHERIA CENTRIC{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Page Header -->
    <div class="bg-gradient-to-r from-green-600 to-emerald-600 rounded-2xl shadow-xl border border-green-200 p-6 mb-6 text-white">
        <div class="flex flex-col md:flex-row items-center justify-between">
            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                {% if employee %}
                <a href="{{ url_for('employee_communications') }}" class="text-white hover:text-green-200 transition-colors">
                    <i class="fas fa-arrow-left text-xl"></i>
                </a>
                {% endif %}
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold mb-2 flex items-center">
                        <i class="fas fa-comments mr-3"></i>
                        Employee Communications
                    </h1>
                    <p class="text-green-100">Manage employee communication channels and work emails</p>
                </div>
            </div>
        </div>
    </div>

    {% if employee %}
    <!-- Employee Profile Header -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mb-6">
        <div class="flex items-center space-x-6">
            {% if employee.profile_picture %}
            <img src="/static/uploads/profile_pictures/{{ employee.profile_picture }}" 
                 alt="{{ employee.full_name }}" 
                 class="w-24 h-24 rounded-full object-cover border-4 border-green-200"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            {% endif %}
            <div class="h-24 w-24 rounded-full bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center text-white text-3xl font-bold {% if employee.profile_picture %}hidden{% endif %}">
                {{ employee.full_name[0] if employee.full_name else '?' }}
            </div>
            <div class="flex-1">
                <h2 class="text-2xl font-bold text-gray-900">{{ employee.full_name }}</h2>
                <p class="text-gray-600">{{ employee.role }} • {{ employee.employee_code }}</p>
                <p class="text-sm text-gray-500 mt-1">{{ employee.work_email or 'No work email assigned' }}</p>
            </div>
        </div>
    </div>

    <!-- Communication Tabs -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 mb-6">
        <div class="border-b border-gray-200">
            <nav class="flex -mb-px" aria-label="Tabs">
                <button onclick="switchCommTab('email')" id="comm-tab-email" class="comm-tab-button active flex-1 py-4 px-6 text-center font-semibold text-sm border-b-2 border-indigo-600 text-indigo-600">
                    <i class="fas fa-envelope mr-2"></i>Email Communications
                </button>
                <button onclick="switchCommTab('whatsapp')" id="comm-tab-whatsapp" class="comm-tab-button flex-1 py-4 px-6 text-center font-semibold text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    <i class="fab fa-whatsapp mr-2"></i>WhatsApp
                </button>
                <button onclick="switchCommTab('sms')" id="comm-tab-sms" class="comm-tab-button flex-1 py-4 px-6 text-center font-semibold text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    <i class="fas fa-sms mr-2"></i>SMS
                </button>
            </nav>
        </div>
    </div>

    <!-- Email Communications Tab -->
    <div id="comm-content-email" class="comm-tab-content">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-envelope text-indigo-600 mr-3"></i>
                    Email Communications
                </h3>
                <button 
                    onclick="fetchEmployeeEmails({{ employee.id }})"
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors duration-200 font-semibold text-sm"
                >
                    <i class="fas fa-sync mr-2"></i>Refresh Emails
                </button>
            </div>
            
            <!-- Search Bar -->
            <div class="mb-6">
                <div class="relative">
                    <input 
                        type="text" 
                        id="emailSearch" 
                        placeholder="Search emails by subject, sender, or content..."
                        class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        onkeyup="filterEmails()"
                    />
                    <i class="fas fa-search absolute left-4 top-3.5 text-gray-400"></i>
                </div>
            </div>
            
            <!-- Email List -->
            <div id="emailCommunicationsList" class="space-y-3">
                <div class="text-center py-12">
                    <i class="fas fa-envelope-open text-gray-400 text-5xl mb-4"></i>
                    <p class="text-gray-600">Click "Refresh Emails" to fetch communications</p>
                </div>
            </div>
        </div>
    </div>

    <!-- WhatsApp Communications Tab -->
    <div id="comm-content-whatsapp" class="comm-tab-content hidden">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8">
            <div class="text-center py-12">
                <i class="fab fa-whatsapp text-green-400 text-5xl mb-4"></i>
                <p class="text-gray-600 text-lg">WhatsApp Communications</p>
                <p class="text-gray-500 mt-2">
                    <span class="px-3 py-1 bg-yellow-100 text-yellow-700 text-sm rounded-full">Coming Soon</span>
                </p>
            </div>
        </div>
    </div>

    <!-- SMS Communications Tab -->
    <div id="comm-content-sms" class="comm-tab-content hidden">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8">
            <div class="text-center py-12">
                <i class="fas fa-sms text-blue-400 text-5xl mb-4"></i>
                <p class="text-gray-600 text-lg">SMS Communications</p>
                <p class="text-gray-500 mt-2">
                    <span class="px-3 py-1 bg-yellow-100 text-yellow-700 text-sm rounded-full">Coming Soon</span>
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    {% if not employee %}
    <!-- Employees Table -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8 mb-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                <i class="fas fa-users text-green-600 mr-3"></i>
                Active Employees
            </h2>
            <button 
                onclick="refreshEmployees()"
                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 font-semibold text-sm"
            >
                <i class="fas fa-sync mr-2"></i>Refresh
            </button>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Personal Email</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Work Email</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">WhatsApp Number</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SMS Number</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="employeesTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Employees will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if not employee %}
    <!-- Create Work Email Modal -->
    <div id="createEmailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-gray-900">Create Work Email</h3>
                <button onclick="closeCreateEmailModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="createEmailForm" class="space-y-4">
                <input type="hidden" id="create_email_employee_id" name="employee_id">
                <div>
                    <label for="email_username" class="block text-sm font-semibold text-gray-700 mb-2">
                        Email Username <span class="text-red-500">*</span>
                    </label>
                    <div class="flex items-center">
                        <input 
                            type="text" 
                            id="email_username" 
                            name="email_username"
                            class="flex-1 px-4 py-3 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                            placeholder="username"
                            required
                        />
                        <span class="px-4 py-3 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg text-gray-600">
                            @baunilawgroup.com
                        </span>
                    </div>
                </div>
                <div>
                    <label for="email_password" class="block text-sm font-semibold text-gray-700 mb-2">
                        Password <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="password" 
                        id="email_password" 
                        name="email_password"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        placeholder="Enter password"
                        required
                    />
                </div>
                <div>
                    <label for="link_personal_email" class="block text-sm font-semibold text-gray-700 mb-2">
                        Link to Personal Email
                    </label>
                    <input 
                        type="email" 
                        id="link_personal_email" 
                        name="link_personal_email"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        placeholder="personal@example.com"
                    />
                    <p class="text-xs text-gray-500 mt-1">Forward work emails to this personal email address</p>
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button 
                        type="button"
                        onclick="closeCreateEmailModal()"
                        class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors duration-200 font-semibold"
                    >
                        Cancel
                    </button>
                    <button 
                        type="submit"
                        class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 font-semibold"
                    >
                        <i class="fas fa-plus mr-2"></i>Create Email
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Message Container -->
    <div id="messageContainer" class="hidden fixed top-20 right-4 z-50 max-w-md"></div>
</div>

<script>
// Load employees on page load (only if no employee_id in URL)
{% if not employee %}
document.addEventListener('DOMContentLoaded', function() {
    loadEmployees();
});
{% endif %}

function loadEmployees() {
    const employees = {{ employees | tojson }};
    const emailAccounts = {{ email_accounts | tojson }};
    
    const tbody = document.getElementById('employeesTableBody');
    
    if (!employees || employees.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                    <i class="fas fa-users text-gray-400 text-3xl mb-2 block"></i>
                    No active employees found
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = employees.map(employee => {
        const profilePic = employee.profile_picture ? 
            `/static/uploads/profile_pictures/${employee.profile_picture}` : 
            null;
        
        // Get initials for fallback
        const initials = employee.full_name ? 
            employee.full_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : 
            '??';
        
        const currentEmail = employee.work_email || '';
        const emailOptions = emailAccounts.map(email => {
            const emailAddr = email.email_address || email.email || '';
            const selected = emailAddr === currentEmail ? 'selected' : '';
            return `<option value="${emailAddr}" ${selected}>${emailAddr}</option>`;
        }).join('');
        
        // Check if work email exists
        const hasWorkEmail = currentEmail && currentEmail.trim() !== '';
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        ${profilePic ? 
                            `<img class="h-10 w-10 rounded-full object-cover" src="${profilePic}" alt="${employee.full_name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                             <div class="h-10 w-10 rounded-full bg-green-600 flex items-center justify-center text-white font-semibold text-sm" style="display:none;">${initials}</div>` :
                            `<div class="h-10 w-10 rounded-full bg-green-600 flex items-center justify-center text-white font-semibold text-sm">${initials}</div>`
                        }
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900">${employee.full_name}</div>
                            <div class="text-sm text-gray-500">${employee.employee_code} • ${employee.role}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${employee.phone_number || 'N/A'}</div>
                    <div class="text-xs text-gray-500">Phone: ${employee.phone_number || 'N/A'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${hasWorkEmail ? 
                        `<select 
                            id="email_${employee.id}" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm"
                            onchange="updateEmployeeEmail(${employee.id}, this.value)"
                        >
                            <option value="">-- Select Email --</option>
                            ${emailOptions}
                        </select>` :
                        `<button 
                            onclick="openCreateEmailModal(${employee.id}, '${employee.full_name}')"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 text-sm font-semibold"
                        >
                            <i class="fas fa-plus mr-2"></i>Create Work Email
                        </button>`
                    }
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center text-sm text-gray-500">
                        <i class="fab fa-whatsapp text-green-500 mr-2"></i>
                        <span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-full">Coming Soon</span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center text-sm text-gray-500">
                        <i class="fas fa-sms text-blue-500 mr-2"></i>
                        <span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-full">Coming Soon</span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button 
                        onclick="viewEmployeeDetails(${employee.id})"
                        class="text-green-600 hover:text-green-900 mr-3"
                        title="View Details"
                    >
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function openCreateEmailModal(employeeId, employeeName) {
    document.getElementById('create_email_employee_id').value = employeeId;
    document.getElementById('createEmailModal').classList.remove('hidden');
    // Pre-fill email username with employee code or name
    const username = employeeName.toLowerCase().replace(/\s+/g, '.').substring(0, 20);
    document.getElementById('email_username').value = username;
}

function closeCreateEmailModal() {
    document.getElementById('createEmailModal').classList.add('hidden');
    document.getElementById('createEmailForm').reset();
}

document.getElementById('createEmailForm').addEventListener('submit', function(e) {
    e.preventDefault();
    createWorkEmail();
});

function createWorkEmail() {
    const form = document.getElementById('createEmailForm');
    const formData = new FormData(form);
    
    const employeeId = formData.get('employee_id');
    const username = formData.get('email_username');
    const password = formData.get('email_password');
    const personalEmail = formData.get('link_personal_email');
    
    if (!username || !password) {
        showMessage('Username and password are required', 'error');
        return;
    }
    
    const emailAddress = username + '@baunilawgroup.com';
    
    showMessage('Creating work email in cPanel...', 'info');
    
    fetch('/api/employee/create-work-email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            employee_id: employeeId,
            email_address: emailAddress,
            password: password,
            personal_email: personalEmail
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showMessage('Work email created successfully!', 'success');
            closeCreateEmailModal();
            // Reload page to show updated email
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showMessage(result.error || 'Failed to create work email', 'error');
        }
    })
    .catch(error => {
        showMessage('Error creating work email: ' + error.message, 'error');
    });
}

function updateEmployeeEmail(employeeId, emailAddress) {
    if (!emailAddress) {
        return;
    }
    
    showMessage('Updating employee email...', 'info');
    
    fetch('/api/employee/update-email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            employee_id: employeeId,
            work_email: emailAddress
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showMessage('Employee email updated successfully!', 'success');
        } else {
            showMessage(result.error || 'Failed to update email', 'error');
            // Reload to reset dropdown
            loadEmployees();
        }
    })
    .catch(error => {
        showMessage('Error updating email: ' + error.message, 'error');
        loadEmployees();
    });
}

function refreshEmployees() {
    showMessage('Refreshing employees...', 'info');
    window.location.reload();
}

function viewEmployeeDetails(employeeId) {
    window.location.href = `/employee_communications?employee_id=${employeeId}`;
}

function openEmailConversation(contactEmail, empId) {
    // Use the provided ID or fallback to global variable
    const employeeIdToUse = empId || employeeId || {{ employee.id if employee else 'null' }};
    if (!employeeIdToUse) {
        alert('Employee ID not found');
        return;
    }
    // Encode the email for URL
    const encodedEmail = encodeURIComponent(contactEmail);
    window.location.href = `/employee_communications/${employeeIdToUse}/email/${encodedEmail}`;
}

// Get employee email and ID on page load
{% if employee %}
employeeId = {{ employee.id }};
{% if employee.work_email %}
employeeEmail = {{ employee.work_email | tojson }};
{% endif %}
{% endif %}

// Communication Tabs Functions
function switchCommTab(tab) {
    // Update tab buttons
    document.querySelectorAll('.comm-tab-button').forEach(btn => {
        btn.classList.remove('active', 'text-indigo-600', 'border-indigo-600', 'text-green-600', 'border-green-600', 'text-blue-600', 'border-blue-600');
        btn.classList.add('text-gray-500', 'border-transparent');
    });
    
    const activeTabBtn = document.getElementById(`comm-tab-${tab}`);
    if (tab === 'email') {
        activeTabBtn.classList.add('active', 'text-indigo-600', 'border-indigo-600');
    } else if (tab === 'whatsapp') {
        activeTabBtn.classList.add('active', 'text-green-600', 'border-green-600');
    } else if (tab === 'sms') {
        activeTabBtn.classList.add('active', 'text-blue-600', 'border-blue-600');
    }
    activeTabBtn.classList.remove('text-gray-500', 'border-transparent');
    
    // Update tab content
    document.querySelectorAll('.comm-tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    document.getElementById(`comm-content-${tab}`).classList.remove('hidden');
}

function fetchEmployeeEmails(employeeId) {
    const container = document.getElementById('emailCommunicationsList');
    if (!container) return;
    
    container.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-gray-400 text-3xl mb-4"></i><p class="text-gray-500">Fetching emails...</p></div>';
    
    // Get employee work email first
    fetch(`{{ url_for('get_employee') }}?id=${employeeId}`)
        .then(response => response.json())
        .then(data => {
            if (data.employee && data.employee.work_email) {
                // Fetch emails for this employee
                fetch('/api/email/fetch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email_address: data.employee.work_email,
                        limit: 50
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.emails && result.emails.length > 0) {
                        // Store emails globally before displaying
                        allEmails = result.emails;
                        displayEmailCommunications(result.emails);
                    } else {
                        allEmails = [];
                        container.innerHTML = `
                            <div class="text-center py-12">
                                <i class="fas fa-envelope-open text-gray-400 text-5xl mb-4"></i>
                                <p class="text-gray-600 text-lg">No emails found</p>
                                <p class="text-gray-500 text-sm mt-2">No communications found for this email address</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    allEmails = [];
                    container.innerHTML = `
                        <div class="text-center py-12 text-red-600">
                            <i class="fas fa-exclamation-circle text-3xl mb-4"></i>
                            <p>Error fetching emails: ${error.message}</p>
                        </div>
                    `;
                });
            } else {
                allEmails = [];
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-envelope text-gray-400 text-5xl mb-4"></i>
                        <p class="text-gray-600 text-lg">No work email assigned</p>
                        <p class="text-gray-500 text-sm mt-2">This employee does not have a work email address</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            allEmails = [];
            container.innerHTML = `
                <div class="text-center py-12 text-red-600">
                    <i class="fas fa-exclamation-circle text-3xl mb-4"></i>
                    <p>Error: ${error.message}</p>
                </div>
            `;
        });
}

// Store emails globally for filtering
var allEmails = [];
var employeeId = null;
var employeeEmail = null;

function displayEmailCommunications(emails) {
    const container = document.getElementById('emailCommunicationsList');
    if (!container) return;
    
    // Store emails globally for filtering
    allEmails = emails || [];
    
    if (!emails || emails.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12">
                <i class="fas fa-envelope-open text-gray-400 text-5xl mb-4"></i>
                <p class="text-gray-600 text-lg">No emails found</p>
                <p class="text-gray-500 text-sm mt-2">No communications found for this email address</p>
            </div>
        `;
        return;
    }
    
    // Sort emails by date (newest first)
    const sortedEmails = [...emails].sort((a, b) => {
        const dateA = new Date(a.date || 0);
        const dateB = new Date(b.date || 0);
        return dateB - dateA;
    });
    
    // Extract contact email from 'from' field
    const extractEmail = (emailStr) => {
        if (!emailStr) return 'Unknown';
        const match = emailStr.match(/<(.+)>/);
        return match ? match[1] : emailStr;
    };
    
    const extractName = (emailStr) => {
        if (!emailStr) return 'Unknown';
        if (emailStr.includes('<')) {
            return emailStr.split('<')[0].trim();
        }
        return emailStr;
    };
    
    container.innerHTML = `
        <div class="mb-4 text-sm text-gray-600 flex items-center justify-between">
            <span>
                <i class="fas fa-info-circle mr-2"></i>
                Showing ${sortedEmails.length} email${sortedEmails.length !== 1 ? 's' : ''}
            </span>
        </div>
        <div class="space-y-3">
            ${sortedEmails.map((email, index) => {
                const contactEmail = extractEmail(email.from);
                const contactName = extractName(email.from);
                const isFromContact = contactEmail && contactEmail !== employeeEmail;
                
                const empId = employeeId || {{ employee.id if employee else 'null' }};
                return `
                    <div 
                        onclick="openEmailConversation('${contactEmail}', ${empId})"
                        class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all cursor-pointer hover:bg-indigo-50 hover:border-indigo-300"
                    >
                        <div class="flex items-start space-x-4">
                            <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-envelope text-indigo-600"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start justify-between mb-2">
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-900 mb-1">${email.subject || 'No Subject'}</h4>
                                        <p class="text-sm text-gray-600">
                                            <span class="font-medium">${isFromContact ? 'From' : 'To'}:</span> 
                                            ${contactName} <span class="text-gray-500">&lt;${contactEmail}&gt;</span>
                                        </p>
                                    </div>
                                    <div class="text-right ml-4">
                                        <p class="text-xs text-gray-500 whitespace-nowrap">${formatDate(email.date)}</p>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600 line-clamp-2 mt-2">
                                    ${(email.body || '').replace(/<[^>]*>/g, '').substring(0, 150)}${(email.body || '').length > 150 ? '...' : ''}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function filterEmails() {
    const searchTerm = document.getElementById('emailSearch').value.toLowerCase();
    const container = document.getElementById('emailCommunicationsList');
    
    if (!searchTerm) {
        if (allEmails && allEmails.length > 0) {
            displayEmailCommunications(allEmails);
        }
        return;
    }
    
    if (!allEmails || allEmails.length === 0) {
        return;
    }
    
    const filtered = allEmails.filter(email => {
        const subject = (email.subject || '').toLowerCase();
        const from = (email.from || '').toLowerCase();
        const body = (email.body || '').toLowerCase();
        return subject.includes(searchTerm) || from.includes(searchTerm) || body.includes(searchTerm);
    });
    
    // Display filtered emails without modifying allEmails
    displayEmailCommunications(filtered);
}

function formatDate(dateString) {
    if (!dateString) return 'Unknown';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    } catch {
        return dateString;
    }
}

// Auto-fetch emails if employee_id is in URL
{% if employee %}
document.addEventListener('DOMContentLoaded', function() {
    // Switch to email tab by default
    switchCommTab('email');
    // Auto-fetch emails
    fetchEmployeeEmails({{ employee.id }});
});
{% endif %}

function showMessage(message, type) {
    const container = document.getElementById('messageContainer');
    const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
    
    container.className = `fixed top-20 right-4 z-50 max-w-md ${bgColor} text-white p-4 rounded-lg shadow-lg`;
    container.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${icon} mr-3 text-xl"></i>
            <span>${message}</span>
        </div>
    `;
    container.classList.remove('hidden');
    
    setTimeout(() => {
        container.classList.add('hidden');
    }, 5000);
}
</script>
{% endblock %}

