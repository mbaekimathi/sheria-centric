{% extends "base.html" %}

{% block title %}Human Resource Management - CASELY{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mb-6">
        <div class="flex flex-col md:flex-row items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2 flex items-center">
                    <i class="fas fa-user-tie text-green-600 mr-3"></i>
                    Human Resource Management
                </h1>
                <p class="text-gray-600">Manage employee records, profiles, and organizational structure</p>
            </div>
        </div>
    </div>

    <!-- Welcome Message -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8 mb-6 text-center">
        <div class="max-w-md mx-auto">
            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-user-tie text-white text-4xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-4">HR Management</h2>
            <p class="text-gray-600 mb-6">Access all HR management features from the sidebar</p>
            <p class="text-sm text-gray-500 italic">Use the sidebar to navigate between HR management sections</p>
        </div>
    </div>

    <!-- Tab Content: New Employees Approval -->
    <div id="content-approval" class="tab-content">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-user-check text-green-600 mr-3"></i>
                    Pending Approval Employees
                </h2>
                <span id="pending-count" class="px-4 py-2 bg-yellow-100 text-yellow-800 rounded-full text-sm font-semibold">
                    Loading...
                </span>
            </div>
            
            <div id="approval-list" class="space-y-4">
                <div class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-gray-400 text-3xl mb-4"></i>
                    <p class="text-gray-500">Loading employees...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content: Employee Management -->
    <div id="content-management" class="tab-content hidden">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-users-cog text-green-600 mr-3"></i>
                    All Employees
                </h2>
                <div class="flex items-center space-x-4">
                    <input type="text" id="search-employees" placeholder="Search employees..." 
                           class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                </div>
            </div>
            
            <div id="employees-list" class="space-y-4">
                <div class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-gray-400 text-3xl mb-4"></i>
                    <p class="text-gray-500">Loading employees...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Employee Modal -->
<div id="editEmployeeModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-user-edit text-green-600 mr-3"></i>
                    Edit Employee
                </h2>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        <form id="editEmployeeForm" class="p-6">
            <input type="hidden" id="edit-employee-id" name="employee_id">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="edit-full-name" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-user text-green-600 mr-2"></i>Full Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="edit-full-name" name="full_name" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                </div>

                <div>
                    <label for="edit-phone" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-phone text-orange-600 mr-2"></i>Phone Number <span class="text-red-500">*</span>
                    </label>
                    <input type="tel" id="edit-phone" name="phone_number" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                </div>

                <div>
                    <label for="edit-email" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-envelope text-green-600 mr-2"></i>Work Email <span class="text-red-500">*</span>
                    </label>
                    <input type="email" id="edit-email" name="work_email" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                </div>

                <div>
                    <label for="edit-role" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-user-tag text-orange-600 mr-2"></i>Role <span class="text-red-500">*</span>
                    </label>
                    <select id="edit-role" name="role" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        <option value="Employee">Employee</option>
                        <option value="Firm Administrator">Firm Administrator</option>
                        <option value="Managing Partner">Managing Partner</option>
                        <option value="Finance Office">Finance Office</option>
                        <option value="Associate Advocate">Associate Advocate</option>
                        <option value="Clerk">Clerk</option>
                        <option value="IT Support">IT Support</option>
                    </select>
                </div>

                <div>
                    <label for="edit-status" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-info-circle text-green-600 mr-2"></i>Status <span class="text-red-500">*</span>
                    </label>
                    <select id="edit-status" name="status" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        <option value="Active">Active</option>
                        <option value="Pending Approval">Pending Approval</option>
                        <option value="Suspended">Suspended</option>
                    </select>
                </div>

                <div>
                    <label for="edit-code" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-id-card text-green-600 mr-2"></i>Employee Code
                    </label>
                    <input type="text" id="edit-code" name="employee_code" readonly disabled
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-600 cursor-not-allowed">
                </div>
            </div>

            <div class="mt-6 flex gap-4">
                <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white font-semibold rounded-xl hover:from-green-700 hover:to-green-800 transition-all duration-300 shadow-lg hover:shadow-xl">
                    <i class="fas fa-save mr-2"></i>Save Changes
                </button>
                <button type="button" onclick="closeEditModal()" class="flex-1 px-6 py-3 bg-gray-500 text-white font-semibold rounded-xl hover:bg-gray-600 transition-all duration-300 shadow-lg hover:shadow-xl">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    let currentTab = 'approval';
    
    function switchTab(tab) {
        currentTab = tab;
        
        // Update tab buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active', 'text-green-600', 'border-green-600');
            btn.classList.add('text-gray-500', 'border-transparent');
        });
        
        const activeBtn = document.getElementById(`tab-${tab}`);
        activeBtn.classList.add('active', 'text-green-600', 'border-green-600');
        activeBtn.classList.remove('text-gray-500', 'border-transparent');
        
        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        document.getElementById(`content-${tab}`).classList.remove('hidden');
        
        // Load data for the active tab
        if (tab === 'approval') {
            loadPendingApprovals();
        } else if (tab === 'management') {
            loadAllEmployees();
        }
    }
    
    function loadPendingApprovals() {
        fetch('{{ url_for("get_pending_approvals") }}')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('approval-list');
                const countSpan = document.getElementById('pending-count');
                
                countSpan.textContent = `${data.count || 0} Pending`;
                
                if (data.employees && data.employees.length > 0) {
                    container.innerHTML = data.employees.map(emp => `
                        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200 hover:border-green-300 transition-all">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="w-16 h-16 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-500 flex items-center justify-center text-white text-xl font-bold">
                                        ${emp.full_name.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-900">${emp.full_name}</h3>
                                        <p class="text-sm text-gray-600">${emp.work_email}</p>
                                        <p class="text-xs text-gray-500 mt-1">Code: ${emp.employee_code} | Phone: ${emp.phone_number}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <button onclick="approveEmployee(${emp.id})" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                        <i class="fas fa-check mr-2"></i>Approve
                                    </button>
                                    <button onclick="rejectEmployee(${emp.id})" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                        <i class="fas fa-times mr-2"></i>Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-check-circle text-green-500 text-5xl mb-4"></i>
                            <p class="text-gray-600 text-lg">No pending approvals</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading pending approvals:', error);
                document.getElementById('approval-list').innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-circle text-3xl mb-4"></i>
                        <p>Error loading employees</p>
                    </div>
                `;
            });
    }
    
    function loadAllEmployees() {
        fetch('{{ url_for("get_all_employees") }}')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('employees-list');
                
                if (data.employees && data.employees.length > 0) {
                    renderEmployees(data.employees);
                } else {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-users text-gray-400 text-5xl mb-4"></i>
                            <p class="text-gray-600 text-lg">No employees found</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading employees:', error);
                document.getElementById('employees-list').innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-circle text-3xl mb-4"></i>
                        <p>Error loading employees</p>
                    </div>
                `;
            });
    }
    
    function renderEmployees(employees) {
        const container = document.getElementById('employees-list');
        const searchTerm = document.getElementById('search-employees')?.value.toLowerCase() || '';
        
        const filtered = employees.filter(emp => 
            emp.full_name.toLowerCase().includes(searchTerm) ||
            emp.work_email.toLowerCase().includes(searchTerm) ||
            emp.employee_code.toLowerCase().includes(searchTerm)
        );
        
        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-search text-gray-400 text-5xl mb-4"></i>
                    <p class="text-gray-600 text-lg">No employees match your search</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = filtered.map(emp => {
            const statusClass = emp.status === 'Active' ? 'bg-green-100 text-green-800' : 
                               emp.status === 'Suspended' ? 'bg-red-100 text-red-800' : 
                               'bg-yellow-100 text-yellow-800';
            
            return `
                <div class="bg-gray-50 rounded-xl p-6 border border-gray-200 hover:border-green-300 transition-all">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-green-400 to-green-500 flex items-center justify-center text-white text-xl font-bold">
                                ${emp.full_name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">${emp.full_name}</h3>
                                <p class="text-sm text-gray-600">${emp.work_email}</p>
                                <div class="flex items-center space-x-3 mt-1">
                                    <span class="text-xs text-gray-500">Code: ${emp.employee_code}</span>
                                    <span class="text-xs text-gray-500">|</span>
                                    <span class="text-xs text-gray-500">${emp.role}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusClass}">
                                ${emp.status}
                            </span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" ${emp.status === 'Active' ? 'checked' : ''} 
                                       onchange="toggleEmployeeStatus(${emp.id}, this.checked)"
                                       class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            </label>
                            <button onclick="openEditModal(${emp.id})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-edit mr-2"></i>Edit
                            </button>
                            <button onclick="deleteEmployee(${emp.id}, '${emp.full_name}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                <i class="fas fa-trash mr-2"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function approveEmployee(id) {
        if (confirm('Are you sure you want to approve this employee?')) {
            fetch(`{{ url_for('update_employee_status') }}?id=${id}&status=Active`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadPendingApprovals();
                } else {
                    alert(data.message || 'Error approving employee');
                }
            });
        }
    }
    
    function rejectEmployee(id) {
        if (confirm('Are you sure you want to reject this employee? This will delete their account.')) {
            deleteEmployee(id, 'this employee');
        }
    }
    
    function toggleEmployeeStatus(id, isActive) {
        const status = isActive ? 'Active' : 'Suspended';
        fetch(`{{ url_for('update_employee_status') }}?id=${id}&status=${status}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                alert(data.message || 'Error updating status');
                loadAllEmployees();
            }
        });
    }
    
    function openEditModal(id) {
        fetch(`{{ url_for('get_employee') }}?id=${id}`)
            .then(response => response.json())
            .then(data => {
                if (data.employee) {
                    const emp = data.employee;
                    document.getElementById('edit-employee-id').value = emp.id;
                    document.getElementById('edit-full-name').value = emp.full_name;
                    document.getElementById('edit-phone').value = emp.phone_number;
                    document.getElementById('edit-email').value = emp.work_email;
                    document.getElementById('edit-role').value = emp.role;
                    document.getElementById('edit-status').value = emp.status;
                    document.getElementById('edit-code').value = emp.employee_code;
                    document.getElementById('editEmployeeModal').classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                }
            });
    }
    
    function closeEditModal() {
        document.getElementById('editEmployeeModal').classList.add('hidden');
        document.body.style.overflow = '';
    }
    
    function deleteEmployee(id, name) {
        if (confirm(`Are you sure you want to delete ${name}? This action cannot be undone.`)) {
            fetch(`{{ url_for('delete_employee') }}?id=${id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (currentTab === 'approval') {
                        loadPendingApprovals();
                    } else {
                        loadAllEmployees();
                    }
                } else {
                    alert(data.message || 'Error deleting employee');
                }
            });
        }
    }
    
    // Search functionality
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('search-employees');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                if (currentTab === 'management') {
                    loadAllEmployees();
                }
            });
        }
        
        // Load initial data
        loadPendingApprovals();
        
        // Handle form submission
        document.getElementById('editEmployeeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            fetch('{{ url_for("update_employee") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    closeEditModal();
                    loadAllEmployees();
                } else {
                    alert(result.message || 'Error updating employee');
                }
            });
        });
    });
    
    // Close modal on outside click
    document.getElementById('editEmployeeModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeEditModal();
        }
    });
</script>
{% endblock %}
